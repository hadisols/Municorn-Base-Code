<aura:component implements="force:appHostable,flexipage:availableForRecordHome,force:hasRecordId,force:hasSObjectName,force:lightningQuickActionWithoutHeader" 
    access="global" 
    controller="ChargeController">
	<aura:attribute name="obj" type="Object"/>
    <aura:attribute name="contacts" type="Contact"/>
    <aura:attribute name="opportunities" type="Opportunity"/>
    <aura:attribute name="ShowTransactionDetails" type="boolean" default="false"/>
    <aura:attribute name="ShowEmailConfirmation" type="boolean" default="false"/>
    <aura:attribute name="ShowDefaultPage" type="boolean" default="true"/>
    <aura:attribute name="EnableAddToCardButton" type="boolean" default="true"/>
    <aura:attribute name="Loading" type="boolean" default="true"/>
    <aura:attribute name="PayNow" type="boolean" default="true"/>
    <aura:attribute name="RecordType" type="string"/>
    <aura:attribute name="PaymentAmount" type="double"/>
    <aura:attribute name="EnterAmount" type="boolean" default="true"/>
    <aura:attribute name="NewOpportunityName" type="string"/>
    <aura:attribute name="SelectedOpportunity" type="Object"/>
    <aura:attribute name="SelectedContact" type="Object"/>
    <aura:attribute name="EmailId" type="string"/>
    <aura:attribute name="OpportunityClosed" type="boolean"/>
    <aura:attribute name="ContactFilter" type="Map"/>
    <aura:attribute name="OpportunityFilter" type="Map"/>
    <aura:attribute name="OpportunityDefaultState" type="Map"/>
    <aura:attribute name="CreateNewOpportunity" type="boolean" default="true"/>
    <aura:attribute name="ShowEmail" type="boolean" default="false"/>
    <aura:attribute name="Labels" type="Map"/>
    <aura:attribute name="FrequencyOptions" type="List"/>
    <aura:attribute name="SelectedFrequency" type="String" default="single"/>
    <aura:attribute name="FirstChargeDate" type="String"/>
    <aura:attribute name="UserCards" type="List"/>
    <aura:attribute name="SelectedPaymentSource" type="String"/>
    <aura:attribute name="UserBankAccounts" type="List"/>
    <aura:attribute name="ShowPaymentOptions" type="Boolean" default="false"/>
    <aura:attribute name="DateToday" type="String"/>
    <aura:attribute name="StripePaymentRequest" type="Object"/>
    <aura:attribute name="TxnDetailsColumns" type="List"/>
    <aura:attribute name="TxnDetailsData" type="List"/>
    <aura:attribute name="Txn" type="Object"/>
    <aura:attribute name="CardUILoading" type="boolean" default="true"/>
    <aura:attribute name="cardUrl" type="String"/>
    <aura:attribute name="PaymentMethodsLoading" type="boolean" default="true"/>
    <aura:attribute name="Properties" type="Map"/>
    <aura:attribute name="StripePublishableKey" type="String"/>
    <aura:attribute name="CheckoutItems" type="List"/>
    <aura:attribute name="CheckoutItemsColumns" type="List"/>
    <aura:attribute name="CheckoutResponses" type="List"/>
    <aura:attribute name="PaymentRequestLabel" type="String"/>
    
    <aura:attribute name="selectedAccount" type="Object" />
    <aura:attribute name="gateways" type="List" access="PRIVATE"/>
    <aura:attribute name="selectedGateway" type="String" access="PRIVATE" />
    <aura:attribute name="selectedRows" type="List" default="[]" />

    <aura:html tag="style">
        .cuf-content, .modal-body {
        padding: 0 0rem !important;
        }
        .slds-p-around--medium {
        padding: 0rem !important;
        }
        .slds-modal__content{
        overflow-y:hidden !important;
        height:unset !important;
        max-height:unset !important;
        }
        .cuf-scroller-outside {
        background-color: white !important;
        margin: 0 !important;
        padding: 0 !important;
        }
    </aura:html>
    <aura:handler name="init" action="{!c.doInit}" value="{!this}"/>
    <aura:handler event="force:refreshView" action="{!c.isRefreshed}"/>
    <force:recordData aura:id="recordLoader"
                      recordId="{!v.recordId}"
                      layoutType="FULL"
                      targetFields="{!v.obj}"
                      targetError="{!v.recordError}"
                      recordUpdated="{!c.recordLoaded}"
    />
    <!-- <lightning:tabset selectedTabId="one">
            <lightning:tab label="{!$Label.c.Payment_Details}" id="one">
                <lightning:tabset variant="vertical">
                    <lightning:tab label="{!$Label.c.credit_card}">
                        test 1
                        <iframe aura:id="CardUI" src="/apex/cardUI" onload="{!c.CardLoaded}" frameborder="0" width="100%" height="200"/>
                    </lightning:tab>
                    <lightning:tab label="{!$Label.c.bank}">
                        test 2
                        <iframe aura:id="CardUI" src="/apex/cardUI" onload="{!c.CardLoaded}" frameborder="0" width="100%" height="200"/>
                    </lightning:tab>
                </lightning:tabset>
            </lightning:tab>
    </lightning:tabset>  -->

    <div class="c-container slds-is-relative slds-grow slds-theme_default" style="min-height:250px;">
        <lightning:layoutItem>
            <aura:if isTrue="{!v.Loading}">
                <div>
                    <lightning:spinner alternativeText="Loading" size="medium"/>
                </div>
            </aura:if>
        </lightning:layoutItem>
        <aura:if isTrue="{!v.ShowDefaultPage}">
            
                <lightning:layout multipleRows="true" class="charge-base-page">
                    <lightning:layoutItem padding="around-small" class="frequency-button-group-wrapper"
                                          flexibility="grow">
                        <lightning:select name="gateway" label="Select payment gateway:" aura:id="payment-gateway" value="{!v.selectedGateway}"
                            onchange="{!c.handleGatewayChange}">
                            <aura:iteration items="{!v.gateways}" var="option">
                                <option text="{!option.Name}" value="{!option.Id}" />
                            </aura:iteration>
                        </lightning:select>
                        <lightning:buttonGroup class="frequency-button-group">
                            <aura:iteration items="{!v.FrequencyOptions}" var="option">
                                <lightning:buttonStateful labelWhenOff="{!option.label}"
                                                          labelWhenOn="{!option.label}"
                                                          accesskey="{!option.value}"
                                                          variant="{!v.SelectedFrequency == option.value ? 'brand' : 'neutral'}"
                                                          iconNameWhenOff="standard:choice"
                                                          iconNameWhenOn="utility:check"
                                                          class="{!concat('frequency ', (v.SelectedFrequency == option.value ? 'selected' : ''))}"
                                                          onclick="{!c.selectFrequency}"
                                                          state="{!v.SelectedFrequency == option.value}">
                                </lightning:buttonStateful>
                            </aura:iteration>
                        </lightning:buttonGroup>
                    </lightning:layoutItem>
                </lightning:layout>

                <lightning:layoutItem padding="around-small">
                    <lightning:icon iconName="utility:email" size="xx-small"/>
                    <span style="padding-left: 0.5rem; font-size: 0.8rem;">{!v.EmailId}</span>
                    <span style="padding-left: 0.5rem; position:relative; top: -.1rem; cursor:pointer; color:lightblue;"
                            onclick="{!c.editEmail}"><lightning:icon
                                size="xx-small"
                                iconName="utility:edit"/></span>
                </lightning:layoutItem>
            
                <lightning:layoutItem padding="around-small" flexibility="grow" class="amount-input">
                    <div class="amount-label">
                        <span>Amount</span>
                    </div>
                    <lightning:input type="number" value="{!v.PaymentAmount}" formatter="currency"
                                        step="0.01"
                                        class="amount-input-field"
                                        disabled="{!v.EnterAmount == false || v.RecordType == 'Opportunity'}"/>
                    <aura:if isTrue="{!v.SelectedFrequency != 'single'}">
                        <lightning:input class="first-charge-date" type="date" value="{!v.FirstChargeDate}"
                                            label="First Charge Date" min="{!v.DateToday}"/>
                    </aura:if>
                </lightning:layoutItem>
                <lightning:layoutItem flexibility="grow" padding="around-small"
                                          class="add-to-cart-button-container">
                        <lightning:button class="long-button" label="{!$Label.c.add_to_cart_text}" variant="brand"
                                          iconName="utility:cart"
                                          onclick="{!c.addToCart}"
                                          disabled="{!v.EnableAddToCartButton}"/>
                    </lightning:layoutItem>
                <aura:if isTrue="{!(v.CheckoutItems.length > 0)}">
                    <lightning:layoutItem class="payment-cart" flexibility="grow">
                        <lightning:layoutItem flexibility="grow">
                            <lightning:datatable
                                    aura:id="CheckoutItemsTable"
                                    class="payment-summary-table"
                                    keyField="id"
                                    data="{!v.CheckoutItems}"
                                    columns="{!v.CheckoutItemsColumns}"
                                    oncellchange="{!c.handleInlineEditOfCheckoutItems}"
                                    suppressBottomBar="true"
                                    maxRowSelection="1"
                                    onrowselection="{! c.getSelectedName }"
                                    onrowaction="{!c.handlePaymentSummaryAction}"/>
                        </lightning:layoutItem>
                    </lightning:layoutItem>
                </aura:if>
            </aura:if>
            
            <aura:if isTrue="{!v.ShowEmailConfirmation}">
                <lightning:layout>
                    <lightning:layoutItem flexibility="grow" padding="around-medium">
                        <ui:message title="Info" severity="info">
                            Successfully sent email to {!v.EmailId}!!!
                        </ui:message>
                    </lightning:layoutItem>
                </lightning:layout>
            </aura:if>
            <aura:if isTrue="{!v.ShowPaymentOptions}">
                <lightning:layoutItem flexibility="grow" padding="around-small">
                    <lightning:buttonIcon iconName="utility:back" onclick="{!c.goToDefaultPage}"/>
                </lightning:layoutItem>
                <lightning:layoutItem flexibility="grow" class="payment-options-pane">
                    <lightning:tabset selectedTabId="one">
                        <lightning:tab label="{!$Label.c.Payment_Details}" id="one">
                            <aura:if isTrue="{!v.CardUILoading}">
                                <lightning:spinner alternativeText="Loading" size="small"/>
                            </aura:if>
                            <iframe aura:id="card-ui" src="{!v.cardUrl}" onload="{!c.CardLoaded}" frameborder="0" width="100%" height="200"/>
                            <aura:if isTrue="{!and(v.CheckoutItems.length > 0, v.ShowPaymentOptions)}">
                                
                            </aura:if>
                        </lightning:tab>
                        <lightning:tab label="{!$Label.c.saved_cards}" id="two">
                            <aura:if isTrue="{!v.PaymentMethodsLoading}">
                                <lightning:spinner alternativeText="Loading" size="small"/>
                            </aura:if>
                            <aura:if isTrue="{!empty(v.UserCards)}">
                                <label style="margin-left: 20px">{!$Label.c.no_saved_cards_available}</label>
                            </aura:if>
                            <aura:iteration items="{!v.UserCards}" var="card">
                                <div class="payment-option">
                                    <div onclick="{!c.selectPaymentSource}" id="{!card.id}" title="{!card.name}"
                                         class="payment-card-number slds-grow">
                                        <span class="card-number payment-option-detail">{!'XXXX XXXX ' + card.Card_Number__c}</span>
                                        <span class="card-expiry payment-option-detail">{!card.Card_Type__c}</span>
                                        
                                    </div>
                                    <aura:if isTrue="{!card.id == v.SelectedPaymentSource}">
                                        <div style="text-align: center;">
                                            <lightning:button label="{!$Label.c.process_cart_items}"
                                                              onclick="{!c.handlePaymentMethodCharge}"
                                                              class="payment-card-button" variant="brand"/>
                                        </div>
                                    </aura:if>
                                </div>
                            </aura:iteration>
                        </lightning:tab>
                        
                        <!-- <lightning:tab label="{!$Label.c.ach_saved_accounts}" id="three">
                            <aura:if isTrue="{!v.PaymentMethodsLoading}">
                                <lightning:spinner alternativeText="Loading" size="small"/>
                            </aura:if>
                            <aura:if isTrue="{!empty(v.UserBankAccounts)}">
                                <label style="margin-left: 20px">{!$Label.c.no_saved_cards_available}</label>
                            </aura:if>
                            <aura:iteration items="{!v.UserBankAccounts}" var="bank">
                                <aura:if isTrue="{!bank.status == 'verified'}">
                                    <div class="payment-option">
                                        <div onclick="{!c.selectPaymentSource}" id="{!bank.id}"
                                             title="{!bank.name}"
                                             class="payment-bank-number slds-grow">
                                            <span class="bank-number payment-option-detail">{!bank.last4}</span>
                                            <span class="bank-name payment-option-detail">{!bank.bank_name}</span>
                                            <span class="bank-account-holder-name payment-option-detail">{!bank.account_holder_name}</span>
                                        </div>
                                        <aura:if isTrue="{!bank.id == v.SelectedPaymentSource}">
                                            <div style="text-align: center;">
                                                <lightning:button label="{!$Label.c.process_cart_items}"
                                                                  onclick="{!c.onBankCharge}"
                                                                  class="payment-bank-button" variant="brand"/>
                                            </div>
                                        </aura:if>
                                    </div>
                                </aura:if>
                            </aura:iteration>
                        </lightning:tab> -->
                    </lightning:tabset>
                </lightning:layoutItem>
            </aura:if>

    </div>
    <footer>
        <div class="slds-col modal-footer slds-modal__footer">
            <lightning:layoutItem flexibility="grow" padding="around-small">
                <aura:if isTrue="{!and(v.CheckoutItems.length > 0, v.ShowDefaultPage)}">
                    <lightning:button class="long-button" variant="destructive"
                                      label="{!$Label.c.email + ' (' + v.CheckoutItems.length + ')'}"
                                      iconName="utility:email" onclick="{!c.onSendLinkForRecharge}"/>
                    <lightning:button class="long-button"
                                      iconName="utility:send"
                                      label="{!$Label.c.checkout_cart_items + ' (' + v.CheckoutItems.length + ')'}"
                                      variant="brand"
                                      onclick="{!c.checkoutPayments}"/>
                </aura:if>
            </lightning:layoutItem>
        </div>
    </footer>
	
</aura:component>